!function l(s,c,r){function a(t,e){if(!c[t]){if(!s[t]){var i="function"==typeof require&&require;if(!e&&i)return i(t,!0);if(d)return d(t,!0);var o=new Error("Cannot find module '"+t+"'");throw o.code="MODULE_NOT_FOUND",o}var n=c[t]={exports:{}};s[t][0].call(n.exports,function(e){return a(s[t][1][e]||e)},n,n.exports,l,s,c,r)}return c[t].exports}for(var d="function"==typeof require&&require,e=0;e<r.length;e++)a(r[e]);return a}({1:[function(e,t,i){!function(){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.default={props:["block","index","columnsCount","pageUid","pageId"],mounted:function(){this.block.isNew?this.$nextTick(function(){this.pending=!1}):this.pending=!1,this.block.content._uid||(this.block.content._uid=this.block.content._key+"_"+(new Date).valueOf()+"_"+this._uid),this.activeFieldSet||(this.activeFieldSet=this.fieldSets[0].key);var e=JSON.parse(localStorage.getItem(this.localUiStateKey));e?(this.expanded=e.expanded,this.showPreview=e.showPreview,this.activeFieldSet=e.activeFieldSet):this.storeLocalUiState(),this.block.preview&&this.showPreview?this.displayPreview(this.block.preview):this.showFieldSet(this.activeFieldSet),this.block.isNew&&this.$emit("input")},data:function(){return{pending:!0,activeFieldSet:null,expanded:!0,previewFrameContent:null,previewHeight:0,previewStored:!1,showPreview:!1}},computed:{localUiStateKey:function(){return"kBuilder.uiState."+this.block.content._uid},extendedUid:function(){return this.pageId.replace("/","-")+"-"+this._uid},previewUrl:function(){return this.previewStored?"/kirby-builder-preview/"+this.extendedUid+"?"+this.objectToGetParams(this.block.preview)+"&pageid="+this.pageId:null},fieldSets:function(){var e=[];if(this.block.tabs){for(var t in this.block.tabs)if(this.block.tabs.hasOwnProperty(t)){var i=this.block.tabs[t];e.push(this.newFieldSet(i,t,this.block.content[t]))}}else this.block.fields&&e.push(this.newFieldSet(this.block,"content",this.block.content,"edit","Edit"));return e}},methods:{onBlockInput:function(e){this.$emit("input",this.val)},displayPreview:function(){var e=this;this.showPreview=!0,this.expanded=!0;var t={preview:this.block.preview,blockcontent:this.block.content,blockUid:this.extendedUid};this.$api.post("kirby-builder/preview",t).then(function(){e.previewStored=!0}),this.storeLocalUiState()},showFieldSet:function(e){this.showPreview=!1,this.activeFieldSet=e,this.previewHeight=0,this.expanded=!0,this.storeLocalUiState()},onPreviewLoaded:function(e){this.previewHeight=e.detail.height,this.activeFieldSet=null},toggleExpand:function(){this.expanded=!this.expanded,this.storeLocalUiState()},newFieldSet:function(e,t,i,o,n){var l={fields:e.fields,key:t,model:i,icon:o||e.icon||null,label:n||e.label||null};return l},objectToGetParams:function(t){return Object.keys(t).map(function(e){return e+"="+t[e]}).join("&")},storeLocalUiState:function(){var e={expanded:this.expanded,showPreview:this.showPreview,activeFieldSet:this.activeFieldSet};localStorage.setItem(this.localUiStateKey,JSON.stringify(e))},tabIcon:function(e){return e?-1<e.indexOf("/")&&-1<e.indexOf(".")?null:e:null},tabImage:function(e){return e&&-1<e.indexOf("/")&&-1<e.indexOf(".")?e:null}}}}(),t.exports.__esModule&&(t.exports=t.exports.default);var o="function"==typeof t.exports?t.exports.options:t.exports;o.render=function(){var i=this,e=i.$createElement,o=i._self._c||e;return o("div",{class:["kBuilderBlock","kBuilderBlock--col-"+i.columnsCount,{"kBuilderBlock--pending":i.pending}]},[o("div",{class:"kBuilderBlock__header kBuilderBlock__header--col-"+i.columnsCount},[o("k-icon",{class:"kBuilder__dragDropHandle kBuilder__dragDropHandle--col-"+i.columnsCount,attrs:{type:"sort"}}),i._v(" "),o("span",{staticClass:"kBuilderBlock__label",on:{click:i.toggleExpand}},[o("k-icon",{staticClass:"kBuilderBlock__expandedIcon",class:{"kBuilderBlock__expandedIcon--expanded":i.expanded},attrs:{type:"angle-down"}}),i._v("\n      "+i._s(i.block.label)+"\n    ")],1),i._v(" "),o("div",{staticClass:"kBuilderBlock__actions"},[o("k-button-group",{staticClass:"kBuilderBlock__actionsGroup"},[i._l(i.fieldSets,function(t){return 1<i.fieldSets.length||i.block.preview?o("k-button",{key:"showFierldSetButton-"+i._uid+t.key,staticClass:"kBuilderBlock__actionsButton",class:{"kBuilderBlock__actionsButton--active":i.activeFieldSet==t.key&&i.expanded},attrs:{icon:i.tabIcon(t.icon),image:i.tabImage(t.icon)},on:{click:function(e){i.showFieldSet(t.key)}}},[i._v(i._s(t.label))]):i._e()}),i._v(" "),i.block.preview?o("k-button",{staticClass:"kBuilderBlock__actionsButton",class:{"kBuilderBlock__actionsButton--active":i.showPreview&&i.expanded},attrs:{icon:"preview"},on:{click:function(e){i.displayPreview()}}}):i._e()],2),i._v(" "),o("div",{staticClass:"kBuilderBlock__control"},[o("k-dropdown",{staticClass:"kBuilderBlock__actionsDropDown"},[o("k-button",{staticClass:"kBuilderBlock__actionsButton",attrs:{icon:"dots"},on:{click:function(e){i.$refs["blockActions"+i.block.uniqueKey].toggle()}}}),i._v(" "),o("k-dropdown-content",{ref:"blockActions"+i.block.uniqueKey},[o("k-dropdown-item",{attrs:{icon:"copy"},on:{click:function(e){i.$emit("cloneBlock",i.index)}}},[i._v("Clone")]),i._v(" "),o("k-dropdown-item",{attrs:{icon:"trash"},on:{click:function(e){i.$emit("deleteBlock",i.index)}}},[i._v("Delete")])],1)],1)],1)],1)],1),i._v(" "),o("div",{directives:[{name:"show",rawName:"v-show",value:i.expanded,expression:"expanded"}],staticClass:"kBuilderBlock__content"},[i.block.preview&&i.showPreview&&i.previewUrl?o("iframe",{staticClass:"kBuilder__previewFrame",style:{height:i.previewHeight+"px"},attrs:{src:i.previewUrl},on:{loaded:i.onPreviewLoaded}}):i._e(),i._v(" "),i._l(i.fieldSets,function(t){return i.activeFieldSet===t.key?o("k-fieldset",i._g({key:t.key+i._uid,staticClass:"kBuilderBlock__form",attrs:{value:{},fields:t.fields,validate:!0},model:{value:t.model,callback:function(e){i.$set(t,"model",e)},expression:"fieldSet.model"}},i.$listeners)):i._e()})],2)])},o.staticRenderFns=[]},{}],2:[function(n,e,l){!function(){"use strict";Object.defineProperty(l,"__esModule",{value:!0});var e,i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t=n(1),o=(e=t)&&e.__esModule?e:{default:e};l.default={props:{value:String,fieldsets:Object,columns:Number,limit:Number,label:String,preview:Object,pageId:String,pageUid:String},components:{BuilderBlock:o.default},mounted:function(){var o=this;this.value&&(this.value.forEach(function(e,t){var i=o.fieldsets[e._key];o.blocks.push(o.newBlock(i,e._key,e,t))}),this.lastUniqueKey=this.value.length)},data:function(){return{blocks:[],toggle:!0,targetPosition:null,lastUniqueKey:0,dataField:{label:"date label",type:"date"},dateValue:null}},computed:{val:function(){return this.blocks.map(function(e){return e.content})},columnsCount:function(){return this.columns?this.columns:"1"},columnWidth:function(){return this.columns?"1/"+this.columns:"1/1"},draggableOptions:function(){return{group:"kirby-builder",put:"kirby-builder",clone:!0,forceFallback:!0,handle:".kBuilder__dragDropHandle",scroll:!0}},blockCount:function(){return this.blocks.length},fieldsetCount:function(){return Object.keys(this.fieldsets).length},fieldsetKeys:function(){return Object.keys(this.fieldsets)},addBlockButtonLabel:function(){return 1==this.fieldsetCount?"Add "+this.fieldsets[Object.keys(this.fieldsets)[0]].label:"Add"},supportedBlockTypes:function(){return Object.keys(this.fieldsets)}},methods:{onBlockInput:function(e){this.$emit("input",this.val)},onBlockMoved:function(e){this.$emit("input",this.val)},onBlockAdded:function(e){this.$emit("input",this.val)},onBlockRemoved:function(e){this.$emit("input",this.val)},onMove:function(e){var t=e.relatedContext.index!=this.blocks.length+1,i=0==this.blocks.length,o=this.supportedBlockTypes.includes(e.relatedContext.element.blockKey);return(i||t)&&o},onClickAddBlock:function(e){this.targetPosition=e,1==this.fieldsetCount?this.addBlock(this.fieldsetKeys[0]):this.$refs.dialog.open()},addBlock:function(e){var t=null==this.targetPosition?this.blocks.length:this.targetPosition,i=this.fieldsets[e],o=this.newBlock(i,e,this.getBlankContent(e,i),this.lastUniqueKey++);o.isNew=!0,this.blocks.splice(t,0,JSON.parse(JSON.stringify(o))),this.$refs.dialog.close(),this.targetPosition=null,this.$emit("input",this.val)},getBlankContent:function(e,o){var n={_key:e};if(o.fields)Object.keys(o.fields).forEach(function(e){n[e]=o.fields[e].value||o.fields[e].default||""});else if(o.tabs){var t=function(t){if(n[t]={},o.tabs.hasOwnProperty(t)){var i=o.tabs[t];Object.keys(i.fields).forEach(function(e){n[t][e]=i.fields[e].value||i.fields[e].default||""})}};for(var i in o.tabs)t(i)}return n},cloneBlock:function(e){var t=JSON.parse(JSON.stringify(this.blocks[e]));this.removeProperty(t.content,"_uid"),this.blocks.splice(e+1,0,t),this.blocks[e+1].uniqueKey=this.lastUniqueKey++,this.$emit("input",this.val)},removeProperty:function(e,t){for(prop in e)prop===t?delete e[prop]:"object"===i(e[prop])&&this.removeProperty(e[prop],t)},deleteBlock:function(e){this.clearLocalUiStates(this.blocks[e]),this.blocks.splice(e,1),this.$emit("input",this.val)},clearLocalUiStates:function(e){for(var t in e)if(e.hasOwnProperty(t)){e[t];"_uid"===t?localStorage.removeItem("kBuilder.uiState."+e[t]):"object"===i(e[t])&&this.clearLocalUiStates(e[t])}},newBlock:function(e,t,i,o){return{fields:e.fields?e.fields:null,tabs:e.tabs?e.tabs:null,blockKey:t,content:i,label:e.label,uniqueKey:o,preview:e.preview,showPreview:!1}}}}}(),e.exports.__esModule&&(e.exports=e.exports.default);var t="function"==typeof e.exports?e.exports.options:e.exports;t.render=function(){var o=this,e=o.$createElement,n=o._self._c||e;return n("k-field",{staticClass:"kBuilder",class:"kBuilder--col-"+o.columnsCount,attrs:{label:o.label}},[n("k-draggable",{staticClass:"kBuilder__blocks k-grid",attrs:{move:o.onMove,options:o.draggableOptions},on:{end:function(e){o.drag=!1},update:o.onBlockMoved,add:o.onBlockAdded,remove:o.onBlockRemoved},model:{value:o.blocks,callback:function(e){o.blocks=e},expression:"blocks"}},[o._l(o.blocks,function(t,i){return n("k-column",{key:t.uniqueKey,staticClass:"kBuilder__column",attrs:{width:o.columnWidth}},[n("div",{staticClass:"kBuilder__inlineAddButton",class:{"kBuilder__inlineAddButton--horizontal":1==o.columnsCount,"kBuilder__inlineAddButton--vertical":1<o.columnsCount},on:{click:function(e){o.onClickAddBlock(i)}}}),o._v(" "),n("builder-block",{attrs:{block:t,index:i,columnsCount:o.columnsCount,pageUid:o.pageUid,pageId:o.pageId,showPreview:t.showPreview},on:{"update:showPreview":function(e){o.$set(t,"showPreview",e)},input:o.onBlockInput,cloneBlock:o.cloneBlock,deleteBlock:o.deleteBlock}}),o._v(" "),o.columnsCount%i==0&&1<o.columnsCount?n("div",{staticClass:"kBuilder__inlineAddButton kBuilder__inlineAddButton--vertical kBuilder__inlineAddButton--after",on:{click:function(e){o.onClickAddBlock(i+1)}}}):o._e()],1)}),o._v(" "),!o.limit||o.blockCount<o.limit?n("k-column",{attrs:{width:o.columnWidth}},[n("k-button",{staticClass:"kBuilder__addButton",attrs:{icon:"add"},on:{click:function(e){o.onClickAddBlock()}}},[o._v("\n        "+o._s(o.addBlockButtonLabel)+"\n      ")])],1):o._e()],2),o._v(" "),n("k-dialog",{ref:"dialog"},[n("k-list",o._l(o.fieldsets,function(e,t){return n("k-list-item",{key:t,staticClass:"kBuilder__addBlockButton",attrs:{text:e.label},on:{click:function(e){o.addBlock(t)}}})}))],1)],1)},t.staticRenderFns=[]},{1:1}],3:[function(e,t,i){"use strict";var o,n=e(2),l=(o=n)&&o.__esModule?o:{default:o};panel.plugin("timoetting/k-builder",{fields:{builder:l.default}})},{2:2}]},{},[3]);
